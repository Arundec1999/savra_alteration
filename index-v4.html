<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Alteration Slip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:'Segoe UI',Arial;
  background:#f2f3f7;
  padding:12px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
h2{margin:0 0 6px;text-align:center;}
.section{margin-top:16px;padding-top:12px;border-top:1px solid #eee;}
label{font-size:13px;font-weight:600;margin-bottom:4px;display:block;}
input,select{width:100%;padding:9px;border-radius:6px;border:1px solid #ccc;margin-bottom:10px;font-size:14px;box-sizing:border-box;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
th,td{border:1px solid #e0e0e0;padding:6px;font-size:13px;}
th{background:#f7f7f7;text-align:left;}
button{width:100%;padding:12px;font-size:15px;background:#111;color:white;border:none;border-radius:8px;margin-top:14px;}
.small-note{font-size:12px;color:#777;margin-top:-6px;margin-bottom:8px;}
</style>
</head>
<body>

<div class="card">
<h2>ALTERATION SLIP</h2>

<button onclick="goToSearch()" style="background:#444;margin-bottom:10px;">
üîç Search / Edit Slip
</button>

<div class="section">
<label>Branch</label>
<select id="branch"></select>

<label>Bill Number</label>
<input id="billNo" type="number" placeholder="Enter bill number">
<div class="small-note">Full Bill No: <b id="billPreview">‚Äî</b></div>

<label>Alteration Slip No</label>
<input id="altSlip" readonly>
</div>

<div class="section">
<h3>Customer</h3>
<label>Mobile</label>
<input id="mobile" type="tel">
<label>Name</label>
<input id="customer">
</div>

<div class="section">
<h3>Products for Alteration</h3>
<input id="barcodeInput" placeholder="Scan or Enter Barcode">
<table id="productTable">
<tr><th>Barcode</th><th>Remove</th></tr>
</table>
</div>

<div class="section">
<h3>TOP ‚Äì ‡§ï‡•Å‡§∞‡•ç‡§§‡§æ</h3>
<table id="topTable"></table>
</div>

<div class="section">
<h3>BOTTOM ‚Äì ‡§™‡•à‡§Ç‡§ü</h3>
<table id="bottomTable"></table>
</div>

<div class="section">
<label>Delivery Date</label>
<input id="deliveryDate" type="date">

<label>Delivery Time</label>
<select id="deliveryTime"></select>
</div>

<button onclick="saveSlip()">SAVE & PRINT</button>
</div>

<!-- RECEIPT TEMPLATE -->
<div id="printSlip" style="display:none;
  font-family:'Courier New',monospace;
  font-weight:700;
  width:280px;
  font-size:15px;
  line-height:1.5;
  color:#000;">

<div style="text-align:center;font-size:20px;font-weight:900;">SAVRA</div>
<div id="pBranchAddress" style="font-size:13px;"></div>
<div id="pBranchContact" style="font-size:13px;"></div>
<hr>
Slip: <span id="pSlipNo"></span><br>
Bill: <span id="pBillNo"></span><br>
Date: <span id="pDate"></span> <span id="pTime"></span>
<hr>
Customer: <span id="pName"></span><br>
Mobile: <span id="pMobile"></span>
<hr>
<b>PRODUCTS</b>
<table id="pProducts"></table>
<hr>
<b>TOP</b>
<table id="pTopTable"></table>
<b>BOTTOM</b>
<table id="pBottomTable"></table>
<hr>
Delivery: <span id="pDeliveryDate"></span><br>
Time: <span id="pDeliveryTime"></span>
</div>

<script>
function goToSearch(){ window.location.href="search.html"; }

const API_URL="https://script.google.com/macros/s/AKfycbzr6yQtzBSKwuQtfAYme9vF-5rjYij3P8LM0woZYWxTfX7CycWrAJYc2gYphAKxP2JvQw/exec";
let branchMap={},products=[];

/* ‚úÖ NEW SAFE MEASUREMENT KEYS */
const TOP_FIELDS = [
["top_length","Length (‡§≤‡§Ç‡§¨‡§æ‡§à)"],
["top_u_chest","Upper Chest (‡§ä‡§™‡§∞‡•Ä ‡§õ‡§æ‡§§‡•Ä)"],
["top_chest","Chest (‡§õ‡§æ‡§§‡•Ä)"],
["top_l_chest","Lower Chest (‡§®‡§ø‡§ö‡§≤‡•Ä ‡§õ‡§æ‡§§‡•Ä)"],
["top_waist","Waist (‡§ï‡§Æ‡§∞)"],
["top_hip","Hip (‡§ï‡•Ç‡§≤‡•ç‡§π‡§æ)"],
["top_sleeve","Sleeve (‡§Ü‡§∏‡•ç‡§§‡•Ä‡§®)"],
["top_armhole","Arm Hole (‡§Ü‡§∞‡•ç‡§Æ ‡§π‡•ã‡§≤)"],
["top_mori","Mori (‡§Æ‡•ã‡§∞‡•Ä)"],
["top_bicep","Bicep (‡§¨‡§æ‡§á‡§∏‡•á‡§™‡•ç‡§∏)"],
["top_elbow","Elbow (‡§ï‡•ã‡§π‡§®‡•Ä)"]
];

const BOTTOM_FIELDS = [
["bottom_length","Length (‡§≤‡§Ç‡§¨‡§æ‡§à)"],
["bottom_waist","Waist (‡§ï‡§Æ‡§∞)"],
["bottom_hip","Hip (‡§ï‡•Ç‡§≤‡•ç‡§π‡§æ)"],
["bottom_mori","Mori (‡§Æ‡•ã‡§∞‡•Ä)"],
["bottom_thigh","Thigh (‡§ú‡§æ‡§Ç‡§ò)"],
["bottom_knee","Knee (‡§ò‡•Å‡§ü‡§®‡§æ)"]
];

/* ‚úÖ UPDATED TABLE BUILDER */
function buildTable(id,fields){
 let html="<tr><th>Measurement</th><th>Value</th></tr>";
 fields.forEach(([key,label])=>{
   html+=`<tr data-key="${key}"><td>${label}</td><td><input></td></tr>`;
 });
 document.getElementById(id).innerHTML=html;
}
buildTable("topTable",TOP_FIELDS);
buildTable("bottomTable",BOTTOM_FIELDS);

/* Time slots */
const timeSlots=["11:00 AM","12:00 PM","01:00 PM","02:00 PM","03:00 PM","04:00 PM","05:00 PM","06:00 PM","07:00 PM","08:00 PM","09:00 PM"];
deliveryTime.innerHTML='<option value="">Select Time</option>';
timeSlots.forEach(t=>deliveryTime.innerHTML+=`<option value="${t}">${t}</option>`);

/* Load branches */
window.onload=async()=>{
 const res=await fetch(API_URL+"?action=getBranches");
 const data=await res.json();
 branch.innerHTML=`<option value="">Select Branch</option>`;
 data.branches.forEach(b=>{ branchMap[b.name]=b; branch.innerHTML+=`<option value="${b.name}">${b.name}</option>`; });
};

branch.onchange=billNo.oninput=()=>{
 if(branch.value&&billNo.value){
  billPreview.innerText=branchMap[branch.value].prefix+"-"+billNo.value;
 }
};

mobile.addEventListener("blur",async()=>{
 if(!mobile.value)return;
 const res=await fetch(API_URL+"?action=getCustomer&mobile="+mobile.value);
 const d=await res.json();
 if(d.found) customer.value=d.name;
});

barcodeInput.addEventListener("keypress",e=>{
 if(e.key==="Enter"){
  e.preventDefault();
  products.push(barcodeInput.value.trim());
  barcodeInput.value="";
  renderProducts();
 }
});
function renderProducts(){
 productTable.innerHTML="<tr><th>Barcode</th><th>Remove</th></tr>";
 products.forEach((p,i)=>productTable.innerHTML+=`<tr><td>${p}</td><td><button onclick="products.splice(${i},1);renderProducts()">X</button></td></tr>`);
}

function readTable(id){
 let o={};
 document.querySelectorAll(`#${id} tr[data-key]`).forEach(r=>{
  const v=r.querySelector("input").value.trim();
  if(v)o[r.dataset.key]=v;
 });
 return o;
}

/* Label maps for printing */
function labelMap(fields){const m={};fields.forEach(([k,l])=>m[k]=l);return m;}
const topLabels=labelMap(TOP_FIELDS);
const bottomLabels=labelMap(BOTTOM_FIELDS);

async function saveSlip(){
 if(!branch.value||!billNo.value||!mobile.value||!customer.value){alert("Fill all mandatory");return;}
 const b=branchMap[branch.value];

 const topData=readTable("topTable");
 const bottomData=readTable("bottomTable");

 const url=API_URL+`?action=saveSlip&branch=${branch.value}&billPrefix=${b.prefix}&billNo=${billNo.value}&mobile=${mobile.value}&name=${encodeURIComponent(customer.value)}`;

 const urlWithData=url+
 "&products="+encodeURIComponent(JSON.stringify(products))+
 "&top="+encodeURIComponent(JSON.stringify(topData))+
 "&bottom="+encodeURIComponent(JSON.stringify(bottomData))+
 "&deliveryDate="+deliveryDate.value+
 "&deliveryTime="+deliveryTime.value;

 const res=await fetch(urlWithData,{method:"POST"});
 const data=await res.json();

 if(data.status==="success"){
  altSlip.value=data.slipNo;

  pSlipNo.innerText=data.slipNo;
  pBillNo.innerText=b.prefix+"-"+billNo.value;
  pDate.innerText=new Date().toLocaleDateString();
  pTime.innerText=new Date().toLocaleTimeString();
  pName.innerText=customer.value;
  pMobile.innerText=mobile.value;
  pDeliveryDate.innerText=deliveryDate.value;
  pDeliveryTime.innerText=deliveryTime.value;
  pBranchAddress.innerText=b.address;
  pBranchContact.innerText="Contact: "+b.contact;

  pProducts.innerHTML=products.map(p=>`<tr><td>${p}</td></tr>`).join("");
  pTopTable.innerHTML=Object.entries(topData).map(([k,v])=>`<tr><td>${topLabels[k]||k}</td><td>${v}</td></tr>`).join("");
  pBottomTable.innerHTML=Object.entries(bottomData).map(([k,v])=>`<tr><td>${bottomLabels[k]||k}</td><td>${v}</td></tr>`).join("");

  const w=window.open('','','width=320,height=700');
  w.document.write(`<html><body style="font-family:Courier New;font-weight:700;font-size:15px;width:280px;padding:6px;">${printSlip.innerHTML}</body></html>`);
  w.document.close();w.print();w.close();
 }
}
</script>
</body>
</html>
