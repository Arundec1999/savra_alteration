/***********************
 * CONFIG
 ***********************/
const SHEET_CUSTOMERS = "CUSTOMERS";
const SHEET_SLIPS = "ALTERATION_SLIPS";
const SHEET_BRANCH = "BRANCH_MASTER";

/***********************
 * ENTRY POINTS
 ***********************/
function doGet(e) {
  try {
    const action = e.parameter.action;
    if (action === "getCustomer") return getCustomer(e);
    if (action === "getSlip") return getSlip(e);
    return respond({ status: "error", message: "Invalid GET action" });
  } catch (err) {
    return respond({ status: "error", message: err.toString() });
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.action === "saveSlip") return saveSlip(data);
    return respond({ status: "error", message: "Invalid POST action" });
  } catch (err) {
    return respond({ status: "error", message: err.toString() });
  }
}

/***********************
 * CUSTOMER FETCH
 ***********************/
function getCustomer(e) {
  const mobile = e.parameter.mobile;
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_CUSTOMERS);
  const rows = sh.getDataRange().getValues();

  for (let i = 1; i < rows.length; i++) {
    if (String(rows[i][2]) === String(mobile)) {
      return respond({
        found: true,
        customerID: rows[i][0],
        name: rows[i][1]
      });
    }
  }
  return respond({ found: false });
}

/***********************
 * FETCH SLIP (OPTIONAL â€“ FUTURE USE)
 ***********************/
function getSlip(e) {
  const key = e.parameter.key;
  const sh = SpreadsheetApp.getActive().getSheetByName(SHEET_SLIPS);
  const rows = sh.getDataRange().getValues();

  for (let i = 1; i < rows.length; i++) {
    const altSlip = rows[i][0];
    const billRef = `${rows[i][2]}-${rows[i][3]}`;

    if (altSlip === key || billRef === key) {
      return respond({ found: true, data: rows[i] });
    }
  }
  return respond({ found: false });
}

/***********************
 * SAVE SLIP
 ***********************/
function saveSlip(d) {
  const ss = SpreadsheetApp.getActive();
  const shCust = ss.getSheetByName(SHEET_CUSTOMERS);
  const shSlip = ss.getSheetByName(SHEET_SLIPS);
  const shBranch = ss.getSheetByName(SHEET_BRANCH);

  /******** CUSTOMER ********/
  let customerID = "";
  const custRows = shCust.getDataRange().getValues();

  for (let i = 1; i < custRows.length; i++) {
    if (String(custRows[i][2]) === String(d.mobile)) {
      customerID = custRows[i][0];
      shCust.getRange(i + 1, 5).setValue(new Date()); // Last Visit
      break;
    }
  }

  if (!customerID) {
    customerID = "CUST-" + Date.now();
    shCust.appendRow([
      customerID,
      d.name,
      d.mobile,
      new Date(), // First Visit
      new Date()  // Last Visit
    ]);
  }

  /******** ALTERATION SLIP NUMBER ********/
  const branchRows = shBranch.getDataRange().getValues();
  let slipNo = "";

  for (let i = 1; i < branchRows.length; i++) {
    if (branchRows[i][1] === d.billPrefix) {
      const nextCounter = Number(branchRows[i][2]) + 1;
      shBranch.getRange(i + 1, 3).setValue(nextCounter);
      slipNo = `ALT-${d.billPrefix}-${String(nextCounter).padStart(6, "0")}`;
      break;
    }
  }

  if (!slipNo) {
    throw new Error("Branch prefix not found in BRANCH_MASTER");
  }

  /******** SAVE SLIP ********/
  shSlip.appendRow([
    slipNo,                 // AltSlipNo
    d.branch,               // Branch
    d.billPrefix,           // BillPrefix
    d.billNo,               // BillNo
    customerID,             // CustomerID
    d.name,                 // CustomerName
    d.mobile,               // Mobile
    JSON.stringify(d.top),  // TopMeasurements
    JSON.stringify(d.bottom),// BottomMeasurements
    d.deliveryDate,         // DeliveryDate
    d.deliveryTime,         // DeliveryTime
    new Date(),             // CreatedAt
    new Date()              // LastUpdated
  ]);

  return respond({ status: "success", slipNo });
}

/***********************
 * RESPONSE HELPER
 ***********************/
function respond(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}
