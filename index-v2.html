<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Alteration Slip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  padding:10px;
}
.card{
  max-width:480px;
  margin:auto;
  background:#fff;
  padding:14px;
  border-radius:10px;
  box-shadow:0 6px 16px rgba(0,0,0,.12);
}
h2,h3{
  text-align:center;
  margin:8px 0;
}
label{
  font-size:14px;
  font-weight:bold;
}
input, select{
  width:100%;
  padding:7px;
  margin-bottom:8px;
  font-size:14px;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:10px;
}
th,td{
  border:1px solid #ccc;
  padding:6px;
  font-size:13px;
}
th{
  background:#eee;
}
button{
  width:100%;
  padding:10px;
  font-size:16px;
  background:black;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
@media print{
  body{ background:white; }
  button{ display:none; }
  .card{ box-shadow:none; }
}
</style>
</head>

<body>

<div class="card">

<h2>ALTERATION SLIP</h2>

<!-- BRANCH -->
<label>Branch / ‡§∂‡§æ‡§ñ‡§æ</label>
<select id="branch">
  <option value="">Loading branches...</option>
</select>

<label>Bill Prefix</label>
<input id="billPrefix" readonly>

<label>Bill Number *</label>
<input id="billNo" type="number">

<label>Alteration Slip No</label>
<input id="altSlip" readonly>

<hr>

<!-- CUSTOMER -->
<h3>Customer Details / ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£</h3>

<label>Mobile Number *</label>
<input id="mobile" type="tel" onblur="fetchCustomer()">

<label>Customer Name *</label>
<input id="customer">

<hr>

<!-- TOP -->
<h3>TOP ‚Äì ‡§ï‡•Å‡§∞‡•ç‡§§‡§æ</h3>
<table id="topTable">
<tr><th>Measurement</th><th>Value</th></tr>
<tr data-key="Length"><td>Length</td><td><input></td></tr>
<tr data-key="Chest"><td>Chest</td><td><input></td></tr>
<tr data-key="Sleeve"><td>Sleeve</td><td><input></td></tr>
</table>

<!-- BOTTOM -->
<h3>BOTTOM ‚Äì ‡§™‡•à‡§Ç‡§ü</h3>
<table id="bottomTable">
<tr><th>Measurement</th><th>Value</th></tr>
<tr data-key="Length"><td>Length</td><td><input></td></tr>
<tr data-key="Waist"><td>Waist</td><td><input></td></tr>
</table>

<hr>

<!-- DELIVERY -->
<h3>Delivery</h3>
<input id="deliveryDate" type="date">
<input id="deliveryTime" type="time">

<button type="button" onclick="saveSlip()">SAVE & PRINT</button>

</div>

<script>
/* üîí YOUR APPS SCRIPT URL */
const API_URL = "https://script.google.com/macros/s/AKfycbzr6yQtzBSKwuQtfAYme9vF-5rjYij3P8LM0woZYWxTfX7CycWrAJYc2gYphAKxP2JvQw/exec";

let branchMap = {};

/* LOAD BRANCHES */
window.onload = loadBranches;

async function loadBranches(){
  try{
    const res = await fetch(API_URL + "?action=getBranches");
    const data = await res.json();

    const sel = document.getElementById("branch");
    sel.innerHTML = `<option value="">Select Branch</option>`;

    data.branches.forEach(b=>{
      branchMap[b.name] = b.prefix;
      sel.innerHTML += `<option value="${b.name}">${b.name}</option>`;
    });
  }catch(err){
    alert("Failed to load branches");
    console.error(err);
  }
}

/* FETCH CUSTOMER */
async function fetchCustomer(){
  if(!mobile.value) return;
  const res = await fetch(
    API_URL + "?action=getCustomer&mobile=" + encodeURIComponent(mobile.value)
  );
  const data = await res.json();
  if(data.found){
    customer.value = data.name;
  }
}

/* READ MEASUREMENT TABLE */
function readTable(tableId){
  let obj = {};
  document.querySelectorAll(`#${tableId} tr[data-key]`).forEach(row=>{
    const key = row.dataset.key;
    const val = row.querySelector("input").value.trim();
    if(val !== "") obj[key] = val;
  });
  return JSON.stringify(obj);
}

/* SAVE SLIP ‚Äì FINAL & SAFE */
async function saveSlip(){

  if(!branch.value){
    alert("Please select branch");
    return;
  }

  /* üî• PREFIX ALWAYS DERIVED HERE */
  const prefix = branchMap[branch.value];
  if(!prefix){
    alert("Bill prefix missing ‚Äì check BRANCH_MASTER");
    return;
  }
  billPrefix.value = prefix;

  if(!billNo.value){
    alert("Please enter bill number");
    return;
  }
  if(!mobile.value){
    alert("Please enter mobile number");
    return;
  }
  if(!customer.value){
    alert("Please enter customer name");
    return;
  }

  const payload = {
    branch: branch.value.trim(),
    billPrefix: prefix.trim(),
    billNo: billNo.value.trim(),
    mobile: mobile.value.trim(),
    name: customer.value.trim(),
    top: readTable("topTable"),
    bottom: readTable("bottomTable"),
    deliveryDate: deliveryDate.value || "",
    deliveryTime: deliveryTime.value || ""
  };

  const body = Object.keys(payload)
    .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(payload[k]))
    .join("&");

  try{
    const res = await fetch(API_URL + "?action=saveSlip", {
      method: "POST",
      body: body
    });

    const data = JSON.parse(await res.text());

    if(data.status === "success"){
      altSlip.value = data.slipNo;
      alert("Saved Successfully");
      window.print();
    }else{
      alert("Save failed: " + (data.message || "Unknown error"));
    }

  }catch(err){
    console.error(err);
    alert("Connection error");
  }
}
</script>

</body>
</html>
