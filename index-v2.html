<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Alteration Slip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
.card{max-width:480px;margin:auto;background:#fff;padding:14px;border-radius:10px}
h2,h3{text-align:center}
label{font-weight:bold;font-size:14px}
input,select{width:100%;padding:7px;margin-bottom:8px}
table{width:100%;border-collapse:collapse;margin-bottom:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:13px}
th{background:#eee}
button{width:100%;padding:10px;background:black;color:white;border:none;border-radius:6px}
@media print{button{display:none}}
</style>
</head>

<body>

<div class="card">
<h2>ALTERATION SLIP</h2>

<label>Branch / शाखा</label>
<select id="branch" onchange="setPrefix()">
  <option value="">Loading branches...</option>
</select>

<label>Bill Prefix</label>
<input id="billPrefix" readonly>

<label>Bill Number *</label>
<input id="billNo" type="number">

<label>Alteration Slip No</label>
<input id="altSlip" readonly>

<hr>

<h3>Customer Details</h3>

<label>Mobile *</label>
<input id="mobile" onblur="fetchCustomer()">

<label>Name *</label>
<input id="customer">

<hr>

<h3>TOP – कुर्ता</h3>
<table id="topTable">
<tr><th>Measurement</th><th>Value</th></tr>
<tr data-key="Length"><td>Length</td><td><input></td></tr>
<tr data-key="Chest"><td>Chest</td><td><input></td></tr>
<tr data-key="Sleeve"><td>Sleeve</td><td><input></td></tr>
</table>

<h3>BOTTOM – पैंट</h3>
<table id="bottomTable">
<tr><th>Measurement</th><th>Value</th></tr>
<tr data-key="Length"><td>Length</td><td><input></td></tr>
<tr data-key="Waist"><td>Waist</td><td><input></td></tr>
</table>

<hr>

<label>Delivery Date</label>
<input id="deliveryDate" type="date">
<label>Delivery Time</label>
<input id="deliveryTime" type="time">

<button onclick="saveSlip()">SAVE & PRINT</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzr6yQtzBSKwuQtfAYme9vF-5rjYij3P8LM0woZYWxTfX7CycWrAJYc2gYphAKxP2JvQw/exec";
let branchMap = {};

window.onload = loadBranches;

/* FETCH BRANCHES */
async function loadBranches(){
  const res = await fetch(API_URL + "?action=getBranches");
  const data = await res.json();

  const sel = document.getElementById("branch");
  sel.innerHTML = `<option value="">Select Branch</option>`;

  data.branches.forEach(b=>{
    branchMap[b.name] = b.prefix;
    sel.innerHTML += `<option value="${b.name}">${b.name}</option>`;
  });
}

/* PREFIX AUTO */
function setPrefix(){
  billPrefix.value = branchMap[branch.value] || "";
}

/* CUSTOMER FETCH */
async function fetchCustomer(){
  if(!mobile.value) return;
  const res = await fetch(API_URL + "?action=getCustomer&mobile=" + mobile.value);
  const data = await res.json();
  if(data.found) customer.value = data.name;
}

/* READ TABLE */
function readTable(id){
  let o={};
  document.querySelectorAll(`#${id} tr[data-key]`).forEach(r=>{
    const v=r.querySelector("input").value;
    if(v) o[r.dataset.key]=v;
  });
  return JSON.stringify(o);
}

/* SAVE */
async function saveSlip(){
  if(!branch.value || !billNo.value || !mobile.value || !customer.value){
    alert("Fill mandatory fields"); return;
  }

  const payload={
    action:"saveSlip",
    branch:branch.value,
    billPrefix:billPrefix.value,
    billNo:billNo.value,
    mobile:mobile.value,
    name:customer.value,
    top:readTable("topTable"),
    bottom:readTable("bottomTable"),
    deliveryDate:deliveryDate.value,
    deliveryTime:deliveryTime.value
  };

  const body=Object.keys(payload).map(
    k=>encodeURIComponent(k)+"="+encodeURIComponent(payload[k])
  ).join("&");

  const res=await fetch(API_URL,{method:"POST",body});
  const data=JSON.parse(await res.text());

  if(data.status==="success"){
    altSlip.value=data.slipNo;
    alert("Saved");
    window.print();
  }else{
    alert("Save failed: "+(data.message||""));
  }
}
</script>

</body>
</html>
