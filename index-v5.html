<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Alteration Slip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:'Segoe UI',Arial;
  background:#f2f3f7;
  padding:12px;
}
.card{
  max-width:520px;
  margin:auto;
  background:#fff;
  padding:18px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
}
h2{margin:0 0 6px;text-align:center;}
.section{margin-top:16px;padding-top:12px;border-top:1px solid #eee;}
label{font-size:13px;font-weight:600;margin-bottom:4px;display:block;}
input,select{width:100%;padding:9px;border-radius:6px;border:1px solid #ccc;margin-bottom:10px;font-size:14px;box-sizing:border-box;}
table{width:100%;border-collapse:collapse;margin-top:6px;}
th,td{border:1px solid #e0e0e0;padding:6px;font-size:13px;}
th{background:#f7f7f7;text-align:left;}
button{width:100%;padding:12px;font-size:15px;background:#111;color:white;border:none;border-radius:8px;margin-top:14px;}
.small-note{font-size:12px;color:#777;margin-top:-6px;margin-bottom:8px;}
</style>
</head>
<body>

<div class="card">
<h2>ALTERATION SLIP</h2>

<button onclick="goToSearch()" style="background:#444;margin-bottom:10px;">üîç Search / Edit Slip</button>

<div class="section">
<label>Branch</label>
<select id="branch"></select>

<label>Bill Number</label>
<input id="billNo" type="number" placeholder="Enter bill number">
<div class="small-note">Full Bill No: <b id="billPreview">‚Äî</b></div>

<label>Alteration Slip No</label>
<input id="altSlip" readonly>
</div>

<div class="section">
<h3>Customer</h3>
<label>Mobile</label>
<input id="mobile" type="tel">
<label>Name</label>
<input id="customer">
</div>

<div class="section">
<h3>Products for Alteration</h3>
<input id="barcodeInput" placeholder="Scan or Enter Barcode">
<table id="productTable">
<tr><th>Barcode</th><th>Remove</th></tr>
</table>
</div>

<div class="section">
<h3>TOP ‚Äì ‡§ï‡•Å‡§∞‡•ç‡§§‡§æ</h3>
<table id="topTable"></table>
</div>

<div class="section">
<h3>BOTTOM ‚Äì ‡§™‡•à‡§Ç‡§ü</h3>
<table id="bottomTable"></table>
</div>

<div class="section">
<label>Delivery Date</label>
<input id="deliveryDate" type="date">

<label>Delivery Time</label>
<select id="deliveryTime"></select>
</div>

<button onclick="saveSlip()">SAVE & PRINT</button>
</div>

<!-- RECEIPT TEMPLATE -->
<div id="printSlip" style="display:none; color:#000;">

<div class="shop-name">SAVRA</div>
<div id="pBranchAddress" class="sub-text"></div>
<div id="pBranchContact" class="sub-text"></div>

<div class="divider"></div>

<div class="row"><span>Slip No / ‡§™‡§∞‡•ç‡§ö‡•Ä ‡§®‡§Ç.</span><span id="pSlipNo"></span></div>
<div class="row"><span>Bill No / ‡§¨‡§ø‡§≤ ‡§®‡§Ç.</span><span id="pBillNo"></span></div>
<div class="row"><span>Date / ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</span><span id="pDate"></span></div>
<div class="row"><span>Time / ‡§∏‡§Æ‡§Ø</span><span id="pTime"></span></div>

<div class="divider"></div>

<div class="section-title">Customer / ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï</div>
<div class="row"><span>Name / ‡§®‡§æ‡§Æ</span><span id="pName"></span></div>
<div class="row"><span>Mobile / ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</span><span id="pMobile"></span></div>

<div class="divider"></div>

<div class="section-title">Products / ‡§ï‡§™‡§°‡§º‡•á</div>
<table id="pProducts"></table>

<div class="divider"></div>

<div class="section-title">TOP Measurements / ‡§ï‡•Å‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§™</div>
<table id="pTopTable"></table>

<div class="section-title">BOTTOM Measurements / ‡§™‡•à‡§Ç‡§ü ‡§®‡§æ‡§™</div>
<table id="pBottomTable"></table>

<div class="divider"></div>

<div class="section-title">Delivery / ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä</div>
<div class="row"><span>Date</span><span id="pDeliveryDate"></span></div>
<div class="row"><span>Time</span><span id="pDeliveryTime"></span></div>

<div class="divider"></div>
<div class="footer">Thank You ‚Ä¢ Visit Again</div>

</div>

<script>
function goToSearch(){window.location.href="search.html";}

const API_URL="https://script.google.com/macros/s/AKfycbzr6yQtzBSKwuQtfAYme9vF-5rjYij3P8LM0woZYWxTfX7CycWrAJYc2gYphAKxP2JvQw/exec";
let branchMap={},products=[];

const TOP_FIELDS = [
["Length","‡§≤‡§Ç‡§¨‡§æ‡§à"],
["Chest","‡§õ‡§æ‡§§‡•Ä"],
["Waist","‡§ï‡§Æ‡§∞"],
["Hip","‡§ï‡•Ç‡§≤‡•ç‡§π‡§æ"],
["Shoulder","‡§ï‡§Ç‡§ß‡§æ"],
["Sleeve Length","‡§Ü‡§∏‡•ç‡§§‡•Ä‡§® ‡§≤‡§Ç‡§¨‡§æ‡§à"],
["Sleeve Round","‡§Ü‡§∏‡•ç‡§§‡•Ä‡§® ‡§ò‡•á‡§∞‡§æ"],
["Armhole","‡§Ü‡§∞‡•ç‡§Æ ‡§π‡•ã‡§≤"],
["Neck Depth Front","‡§ó‡§≤‡§æ ‡§Ü‡§ó‡•á"],
["Neck Depth Back","‡§ó‡§≤‡§æ ‡§™‡•Ä‡§õ‡•á"]
];

const BOTTOM_FIELDS = [
["Length","‡§≤‡§Ç‡§¨‡§æ‡§à"],
["Waist","‡§ï‡§Æ‡§∞"],
["Hip","‡§ï‡•Ç‡§≤‡•ç‡§π‡§æ"],
["Thigh","‡§ú‡§æ‡§Ç‡§ò"],
["Knee","‡§ò‡•Å‡§ü‡§®‡§æ"],
["Bottom","‡§™‡§æ‡§Ø‡§Ç‡§ö‡§æ"]
];


function buildTable(id,fields){
 let html="<tr><th>Measurement</th><th>Value</th></tr>";
 fields.forEach(f=>{
   html+=`<tr data-key="${f[0]}">
            <td>${f[0]} (${f[1]})</td>
            <td><input></td>
          </tr>`;
 });
 document.getElementById(id).innerHTML=html;
}

buildTable("topTable",TOP_FIELDS);
buildTable("bottomTable",BOTTOM_FIELDS);

const timeSlots=["11:00 AM","12:00 PM","01:00 PM","02:00 PM","03:00 PM","04:00 PM","05:00 PM","06:00 PM","07:00 PM","08:00 PM","09:00 PM"];
deliveryTime.innerHTML='<option value="">Select Time</option>';
timeSlots.forEach(t=>deliveryTime.innerHTML+=`<option value="${t}">${t}</option>`);

window.onload=async()=>{
 const res=await fetch(API_URL+"?action=getBranches");
 const data=await res.json();
 branch.innerHTML=`<option value="">Select Branch</option>`;
 data.branches.forEach(b=>{branchMap[b.name]=b;branch.innerHTML+=`<option value="${b.name}">${b.name}</option>`;});
};

branch.onchange=billNo.oninput=()=>{if(branch.value&&billNo.value){billPreview.innerText=branchMap[branch.value].prefix+"-"+billNo.value;}};

mobile.addEventListener("blur",async()=>{
 if(!mobile.value)return;
 const res=await fetch(API_URL+"?action=getCustomer&mobile="+mobile.value);
 const d=await res.json();
 if(d.found) customer.value=d.name;
});

barcodeInput.addEventListener("keypress",e=>{
 if(e.key==="Enter"){e.preventDefault();products.push(barcodeInput.value.trim());barcodeInput.value="";renderProducts();}
});
function renderProducts(){
 productTable.innerHTML="<tr><th>Barcode</th><th>Remove</th></tr>";
 products.forEach((p,i)=>productTable.innerHTML+=`<tr><td>${p}</td><td><button onclick="products.splice(${i},1);renderProducts()">X</button></td></tr>`);
}

function readTable(id){
 let o={};
 document.querySelectorAll(`#${id} tr[data-key]`).forEach(r=>{
  const v=r.querySelector("input").value.trim();
  if(v)o[r.dataset.key]=v;
 });
 return o;
}

async function saveSlip(){
 if(!branch.value||!billNo.value||!mobile.value||!customer.value){alert("Fill all mandatory");return;}
 const b=branchMap[branch.value];

 const topData=readTable("topTable");
 const bottomData=readTable("bottomTable");

 const url=API_URL+`?action=saveSlip&branch=${branch.value}&billPrefix=${b.prefix}&billNo=${billNo.value}&mobile=${mobile.value}&name=${encodeURIComponent(customer.value)}`;

 const urlWithData=url+
 "&products="+encodeURIComponent(JSON.stringify(products))+
 "&top="+encodeURIComponent(JSON.stringify(topData))+
 "&bottom="+encodeURIComponent(JSON.stringify(bottomData))+
 "&deliveryDate="+deliveryDate.value+
 "&deliveryTime="+deliveryTime.value;

 const res=await fetch(urlWithData,{method:"POST"});
 const data=await res.json();

 if(data.status==="success"){
  altSlip.value=data.slipNo;

  pSlipNo.innerText=data.slipNo;
  pBillNo.innerText=b.prefix+"-"+billNo.value;
  pDate.innerText=new Date().toLocaleDateString();
  pTime.innerText=new Date().toLocaleTimeString();
  pName.innerText=customer.value;
  pMobile.innerText=mobile.value;
  pDeliveryDate.innerText=deliveryDate.value;
  pDeliveryTime.innerText=deliveryTime.value;
  pBranchAddress.innerText=b.address;
  pBranchContact.innerText="Contact: "+b.contact;

  pProducts.innerHTML=products.map(p=>`<tr><td>${p}</td></tr>`).join("");
  pTopTable.innerHTML=Object.entries(topData)
    .map(([k,v])=>{
      const f=TOP_FIELDS.find(x=>x[0]===k);
      return `<tr><td>${f?f[0]+" ("+f[1]+")":k}</td><td style="text-align:right">${v}</td></tr>`;
    }).join("");

  pBottomTable.innerHTML=Object.entries(bottomData)
    .map(([k,v])=>{
      const f=BOTTOM_FIELDS.find(x=>x[0]===k);
      return `<tr><td>${f?f[0]+" ("+f[1]+")":k}</td><td style="text-align:right">${v}</td></tr>`;
    }).join("");


  const w=window.open('','','width=320,height=700');
  w.document.write(`
  <html><head>
  <style>
  body{font-family:Arial Black,Arial,sans-serif;font-weight:900;width:280px;padding:10px;color:#000;}
  .shop-name{text-align:center;font-size:22px;margin-bottom:4px;}
  .sub-text{text-align:center;font-size:14px;}
  .section-title{font-size:16px;margin-top:8px;}
  .row{display:flex;justify-content:space-between;font-size:15px;}
  .divider{border-top:2px dashed #000;margin:6px 0;}
  table{width:100%;border-collapse:collapse;font-size:15px;}
  td{padding:2px 0;}
  .footer{text-align:center;font-size:14px;margin-top:6px;}
  </style></head><body>${printSlip.innerHTML}</body></html>`);
  w.document.close();w.print();w.close();
 }
}
</script>
</body>
</html>
