<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Search & Edit Slip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
.card{max-width:520px;margin:auto;background:#fff;padding:15px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.12)}
input,button,select{width:100%;padding:8px;margin:6px 0;font-size:14px}
button{background:black;color:white;border:none;border-radius:6px}
.result{background:#fafafa;padding:10px;margin-top:10px;border-radius:6px;font-size:14px}
hr{margin:10px 0}
h2{text-align:center}
.smallBtn{width:auto;padding:4px 8px;font-size:12px;margin-left:6px}
.locked{background:#eee}
table{width:100%;border-collapse:collapse}
td{padding:4px;font-size:13px}
</style>
</head>
<body>

<div class="card">
<h2>Search & Edit Alteration Slip</h2>

<label>Select Branch</label>
<select id="branch"></select>

<hr>

<input id="searchSlipNo" placeholder="Slip Number (digits only)">
<button onclick="searchBySlip()">Search by Slip No</button>

<input id="searchBillNo" placeholder="Bill Number (digits only)">
<button onclick="searchByBill()">Search by Bill No</button>

<input id="searchMobile" placeholder="Customer Mobile">
<button onclick="searchByMobile()">Search by Mobile</button>

<div id="mobileResults"></div>
<div id="slipDetails" class="result"></div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzr6yQtzBSKwuQtfAYme9vF-5rjYij3P8LM0woZYWxTfX7CycWrAJYc2gYphAKxP2JvQw/exec";
let branchMap={}, currentProducts=[], currentSlip=null;

const TOP_FIELDS=["Length","Chest","Sleeve"];
const BOTTOM_FIELDS=["Length","Waist"];

window.onload=async()=>{
 const res=await fetch(API_URL+"?action=getBranches");
 const data=await res.json();
 branch.innerHTML="<option value=''>Select Branch</option>";
 data.branches.forEach(b=>{
   branchMap[b.name]=b.prefix;
   branch.innerHTML+=`<option value="${b.name}">${b.name}</option>`;
 });
};

function formatSlipNumber(num){
 const prefix = branchMap[branch.value];
 return `ALT-${prefix}-${String(num).padStart(6,'0')}`;
}

async function searchBySlip(){
 if(!branch.value){alert("Select branch");return;}
 const slip=formatSlipNumber(searchSlipNo.value.trim());
 const res=await fetch(API_URL+`?action=searchSlip&branch=${branch.value}&slipNo=${slip}`);
 showSlip(await res.json());
}

async function searchByBill(){
 if(!branch.value){alert("Select branch");return;}
 const prefix=branchMap[branch.value];
 const res=await fetch(API_URL+`?action=searchSlip&branch=${branch.value}&prefix=${prefix}&billNo=${searchBillNo.value}`);
 showSlip(await res.json());
}

async function searchByMobile(){
 if(!branch.value){alert("Select branch");return;}
 const res=await fetch(API_URL+`?action=getSlipsByMobile&branch=${branch.value}&mobile=${searchMobile.value}`);
 const d=await res.json();
 mobileResults.innerHTML="";
 d.slips.forEach(s=>{
  mobileResults.innerHTML+=`<button onclick="loadSlip('${s.slipNo}')">${s.slipNo} | Bill: ${s.billNo} | Delivery: ${s.deliveryDate}</button>`;
 });
}

async function loadSlip(slipNo){
 const res=await fetch(API_URL+`?action=searchSlip&branch=${branch.value}&slipNo=${slipNo}`);
 showSlip(await res.json());
}

function showSlip(d){
 if(d.status!=="success"){slipDetails.innerHTML="Slip not found";return;}
 currentSlip=d;
 currentProducts=[...d.products];

 slipDetails.innerHTML=`
 <b>Slip No:</b> ${d.slipNo}<br>
 <b>Bill:</b> ${d.billPrefix}-${d.billNo}<br>
 <b>Name:</b> ${d.name}<br>
 <b>Mobile:</b> ${d.mobile}<br>
 <b>Created:</b> ${new Date(d.createdDate).toLocaleString()}<hr>

 <b>Delivery Date</b>
 <input type="date" id="editDeliveryDate" value="${d.deliveryDate||""}" disabled class="locked">
 <b>Delivery Time</b>
 <input type="time" id="editDeliveryTime" value="${d.deliveryTime||""}" disabled class="locked">
 <button onclick="unlockDelivery()">Edit Delivery</button>
 <hr>

 <b>Products</b>
 <div id="editProducts"></div>
 <input id="newBarcode" placeholder="Scan new barcode" onkeypress="addEditProduct(event)"><hr>

 <b>Top Measurements</b>
 <table id="editTopTable"></table><hr>

 <b>Bottom Measurements</b>
 <table id="editBottomTable"></table><hr>

 <button onclick="updateSlip()">UPDATE SLIP</button>
 `;

 renderEditableProducts();
 renderMeasurementTable("editTopTable",TOP_FIELDS,d.top);
 renderMeasurementTable("editBottomTable",BOTTOM_FIELDS,d.bottom);
}

function unlockDelivery(){
 editDeliveryDate.disabled=false;
 editDeliveryTime.disabled=false;
 editDeliveryDate.classList.remove("locked");
 editDeliveryTime.classList.remove("locked");
}

function renderEditableProducts(){
 editProducts.innerHTML="";
 currentProducts.forEach((p,i)=>{
  editProducts.innerHTML+=`${p} <button class="smallBtn" onclick="removeEditProduct(${i})">X</button><br>`;
 });
}

function addEditProduct(e){
 if(e.key==="Enter"){
  e.preventDefault();
  currentProducts.push(newBarcode.value);
  newBarcode.value="";
  renderEditableProducts();
 }
}

function removeEditProduct(i){
 currentProducts.splice(i,1);
 renderEditableProducts();
}

function renderMeasurementTable(container,fields,data){
 let html="";
 fields.forEach(f=>{
  html+=`<tr><td>${f}</td><td><input data-key="${f}" value="${data[f]||""}"></td></tr>`;
 });
 document.getElementById(container).innerHTML=html;
}

async function updateSlip(){
 const top={}, bottom={};

 document.querySelectorAll("#editTopTable input").forEach(i=>top[i.dataset.key]=i.value);
 document.querySelectorAll("#editBottomTable input").forEach(i=>bottom[i.dataset.key]=i.value);

 const body=new URLSearchParams({
  action:"updateSlip",
  slipNo:currentSlip.slipNo,
  products:JSON.stringify(currentProducts),
  top:JSON.stringify(top),
  bottom:JSON.stringify(bottom),
  deliveryDate:editDeliveryDate.value,
  deliveryTime:editDeliveryTime.value
 });

 const res=await fetch(API_URL,{method:"POST",body});
 const d=await res.json();

 if(d.status==="success"){alert("Slip updated successfully");}
 else alert("Update failed");
}
</script>

</body>
</html>
